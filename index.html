<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ZYM Pro Hub - International Standard</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <style>
        :root { --bg: #000; --accent: #00f2ff; --card-bg: #0d0d0d; --text-main: #e0e0e0; --text-dim: #a0a0a0; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text-main); height: 100dvh; display: flex; flex-direction: column; overflow: hidden; margin: 0; padding: 15px; }
        .balance-box { background: var(--card-bg); border: 1px solid rgba(0, 242, 255, 0.15); border-radius: 18px; padding: 12px 18px; display: flex; align-items: center; gap: 14px; width: fit-content; }
        .zym-card { background: var(--card-bg); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 35px; padding: 20px; width: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; flex-grow: 0; height: 210px; margin: 15px 0; position: relative; }
        .mining-display { font-size: 42px; font-weight: 900; line-height: 1; letter-spacing: -1.5px; color: #fff; text-shadow: 0 0 20px rgba(0, 242, 255, 0.2); margin: 5px 0; }
        .btn-zym { width: 100%; height: 60px; border-radius: 30px; font-weight: 900; font-size: 16px; text-transform: uppercase; letter-spacing: 2px; display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; transition: 0.3s; }
        .btn-start { background: #fff; color: #000; }
        .btn-active { background: #151515; color: #555; pointer-events: none; border: 1px solid #222; }
        .btn-claim { background: linear-gradient(135deg, #007AFF, #00f2ff); color: #fff; }
        .upgrade-link { width: 100%; height: 52px; margin-top: 12px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); border-radius: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; color: var(--text-dim); text-decoration: none; font-size: 13px; font-weight: 800; text-transform: uppercase; }
        .nav-wrapper { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 94%; z-index: 1000; }
        .nav-container { background: rgba(10, 10, 10, 0.9); backdrop-filter: blur(20px); border-radius: 35px; display: flex; justify-content: space-around; align-items: center; padding: 10px; border: 1px solid rgba(255,255,255,0.08); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #555; font-size: 9px; font-weight: 800; text-transform: uppercase; text-decoration: none; gap: 4px; }
        .nav-item.active { color: var(--accent); }
        .nav-main-btn { position: relative; top: -25px; width: 68px; height: 68px; background: #000; border-radius: 22px; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 30px rgba(0, 242, 255, 0.3); border: 4px solid var(--bg); }
        #overlay { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; font-size: 12px; color: var(--accent); letter-spacing: 4px; font-weight: 900; }
    </style>
</head>
<body>

    <div id="overlay">ZYM ENGINE INITIALIZING...</div>

    <header>
        <div class="balance-box">
            <div class="w-10 h-10 flex items-center justify-center bg-black border border-cyan-500/40 rounded-xl">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#00f2ff" stroke-width="2.5"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
            </div>
            <div>
                <p class="text-[9px] font-black text-gray-400 uppercase tracking-widest">ZYM NODE PROTOCOL</p>
                <div class="flex items-baseline gap-1">
                    <h2 id="main-balance" class="text-2xl font-black text-white">0</h2>
                    <span class="text-[9px] font-black text-cyan-400">ZYM</span>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-grow flex flex-col items-center">
        <div class="zym-card">
            <p class="text-[9px] font-black text-gray-500 uppercase tracking-[4px] mb-3">ACTIVE SESSION</p>
            <div class="relative">
                <svg width="50" height="50" viewBox="0 0 100 100">
                    <path d="M50 5 L90 25 L90 75 L50 95 L10 75 L10 25 Z" fill="none" stroke="#e5e7eb" stroke-width="6"/>
                    <path d="M55 25 L40 52 L52 52 L45 78 L65 45 L50 45 L58 25 Z" fill="#00f2ff"/>
                </svg>
            </div>
            <p class="text-[9px] font-black text-gray-400 uppercase tracking-[2px] mt-4">MINED ALLOCATION</p>
            <h1 id="mining-display" class="mining-display">0.00</h1>
            <p id="timer-text" class="text-xs font-black text-white uppercase tracking-widest mt-2">SYSTEM READY</p>
        </div>

        <button id="action-btn" class="btn-zym btn-start">Start Protocol</button>

        <a href="uppower.html" class="upgrade-link">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#00f2ff" stroke-width="2.5"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
            <span>Upgrade <span style="color:#fff">Your Power</span></span>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#555" stroke-width="3"><path d="M9 18l6-6-6-6"/></svg>
        </a>

        <div style="font-size: 10px; font-weight: 800; color: #555; text-transform: uppercase; letter-spacing: 2px; margin-top: 10px;">
            PROTOCOL POWER: <span id="mining-power-text" style="color:var(--accent)">10000</span> / 8H
        </div>
    </main>

    <!-- Navigation remains same -->
    <div class="nav-wrapper">
        <nav class="nav-container">
            <a href="holding.html" class="nav-item"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M20 7H4a2 2 0 00-2 2v10a2 2 0 002 2h16a2 2 0 002-2V9a2 2 0 00-2-2zM16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/></svg><span>Assets</span></a>
            <a href="objective.html" class="nav-item"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg><span>Tasks</span></a>
            <a href="synthesize.html" class="nav-main-btn">
                <svg viewBox="0 0 100 100" class="w-11 h-11"><path d="M50 5 L92 28 L92 72 L50 95 L8 72 L8 28 Z" fill="none" stroke="#d1d5db" stroke-width="7"/><path d="M55 15 L40 48 L52 48 L45 85 L70 42 L52 42 L62 15 Z" fill="#00f2ff" /></svg>
            </a>
            <a href="kinship.html" class="nav-item"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2M9 7a4 4 0 110-8 4 4 0 010 8zm10 14v-2a4 4 0 00-3-3.87m-4-12a4 4 0 010 7.75"/></svg><span>Network</span></a>
            <a href="config.html" class="nav-item"><svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2"><path d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><circle cx="12" cy="12" r="3"/></svg><span>Config</span></a>
        </nav>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const SECRET = "ZYM_FLUX_99";
        const SESSION_LIMIT = 10 * 60 * 1000;
        const DURATION = 8 * 3600;

        firebase.initializeApp({
            apiKey: "AIzaSyDZpeu9EL9kbJPO7PKEnuoNoMHbYWUSHOU",
            authDomain: "zymtro2.firebaseapp.com",
            projectId: "zymtro2",
            storageBucket: "zymtro2.firebasestorage.app",
            messagingSenderId: "358950686195",
            appId: "1:358950686195:web:e1f743ecf65983dbc69686"
        });
        const db = firebase.firestore();

        const ZYM_STORE = {
            set: (k, v) => localStorage.setItem('zym_'+k, btoa(encodeURIComponent(JSON.stringify(v)))),
            get: (k) => { 
                const d = localStorage.getItem('zym_'+k); 
                if(!d) return null;
                try { 
                    const decoded = decodeURIComponent(atob(d));
                    return JSON.parse(decoded);
                } catch(e) { return null; }
            },
            clearAll: () => {
                Object.keys(localStorage).forEach(key => { 
                    if(key.startsWith('zym_') && key !== 'zym_start_ts') localStorage.removeItem(key); 
                });
            }
        };

        let tgID = tg.initDataUnsafe?.user?.id?.toString() || "7867767";
        let userName = tg.initDataUnsafe?.user?.username || "Guest";
        let startParam = tg.initDataUnsafe?.start_param || null;
        let mainBalance = 0, MINE_LIMIT = 10000, startTime = null, ticker = null;

        async function initApp() {
            const lastActive = ZYM_STORE.get('session_ts');
            const now = Date.now();
            startTime = ZYM_STORE.get('start_ts');

            // নতুন ইউজার বা সেশন শেষ হলে ডাটাবেস থেকে সিঙ্ক হবে
            if (lastActive && (now - lastActive < SESSION_LIMIT)) {
                ZYM_STORE.set('session_ts', now);
                loadLocal();
            } else {
                ZYM_STORE.clearAll();
                await syncFirebase();
            }
        }

        function loadLocal() {
            mainBalance = parseFloat(ZYM_STORE.get('bal')) || 0;
            MINE_LIMIT = parseFloat(ZYM_STORE.get('mine_limit')) || 10000;
            startTime = ZYM_STORE.get('start_ts');
            renderApp();
        }

        async function syncFirebase() {
            const email = `${tgID}@t.me`;
            const pass = `${tgID}${SECRET}`;
            try {
                let userCred;
                try {
                    userCred = await firebase.auth().signInWithEmailAndPassword(email, pass);
                } catch(e) {
                    userCred = await firebase.auth().createUserWithEmailAndPassword(email, pass);
                }

                const userRef = db.collection('users').doc(tgID);
                let doc = await userRef.get();

                if (!doc.exists) {
                    await userRef.set({ 
                        balance: 0, 
                        miningPower: 10000, 
                        total_refer: 0, 
                        username: userName, 
                        referredBy: startParam 
                    });
                    if (startParam && startParam !== tgID) await processReferral(startParam, tgID, userName);
                    doc = await userRef.get();
                }

                const data = doc.data();
                mainBalance = data.balance || 0;
                MINE_LIMIT = data.miningPower || 10000;

                ZYM_STORE.set('bal', mainBalance);
                ZYM_STORE.set('mine_limit', MINE_LIMIT);
                ZYM_STORE.set('session_ts', Date.now());
                renderApp();
            } catch (e) { 
                document.getElementById('overlay').innerText = "NODE CONNECTION ERROR"; 
            }
        }

        async function processReferral(refID, newID, newName) {
            const refRef = db.collection('users').doc(refID);
            try {
                await db.runTransaction(async (t) => {
                    const snap = await t.get(refRef);
                    if (!snap.exists) return;
                    let currentBal = snap.data().balance || 0;
                    let count = (snap.data().total_refer || 0) + 1;
                    let slot = (count > 50) ? ((count - 1) % 50) + 1 : count;
                    
                    t.update(refRef, { 
                        balance: currentBal + 5000, // সরাসরি ব্যালেন্স বাড়ানো
                        total_refer: count,
                        ['user' + slot]: `${newID}: ${newName}`
                    });
                });
            } catch(e){ console.log("Referral error", e); }
        }

        function formatBalance(num) {
            if (num < 1000) return Math.floor(num).toString();
            let val = 0, suffix = "";
            if (num >= 1e9) { val = num / 1e9; suffix = "B"; }
            else if (num >= 1e6) { val = num / 1e6; suffix = "M"; }
            else if (num >= 1e3) { val = num / 1e3; suffix = "K"; }
            return val.toFixed(3) + suffix;
        }

        function renderApp() {
            document.getElementById('main-balance').innerText = formatBalance(mainBalance);
            document.getElementById('mining-power-text').innerText = MINE_LIMIT.toLocaleString();
            document.getElementById('overlay').style.display = 'none';
            
            const btn = document.getElementById('action-btn');
            if (startTime) {
                startTicker();
            } else {
                btn.innerText = "Start Protocol";
                btn.className = "btn-zym btn-start";
                document.getElementById('mining-display').innerText = "0.00";
                document.getElementById('timer-text').innerText = "SYSTEM READY";
            }
        }

        function startTicker() {
            if(ticker) clearInterval(ticker);
            const btn = document.getElementById('action-btn'), RATE = MINE_LIMIT / DURATION;
            
            const updateUI = () => {
                if(!startTime) return;
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const remaining = DURATION - elapsed;

                if (remaining > 0) {
                    document.getElementById('mining-display').innerText = (elapsed * RATE).toFixed(2);
                    const h = Math.floor(remaining / 3600), m = Math.floor((remaining % 3600) / 60);
                    document.getElementById('timer-text').innerText = `${h}H ${m}M REMAINING`;
                    btn.innerText = "PROTOCOL ACTIVE"; btn.className = "btn-zym btn-active";
                } else {
                    clearInterval(ticker);
                    document.getElementById('mining-display').innerText = MINE_LIMIT.toFixed(2);
                    document.getElementById('timer-text').innerText = "ALLOCATION READY";
                    btn.innerText = "CLAIM ALLOCATION"; btn.className = "btn-zym btn-claim";
                }
            };
            updateUI();
            ticker = setInterval(updateUI, 1000);
        }

        document.getElementById('action-btn').addEventListener('click', async () => {
            const btn = document.getElementById('action-btn');
            
            if (!startTime) {
                // মাইনিং শুরু
                startTime = Date.now(); 
                ZYM_STORE.set('start_ts', startTime); 
                startTicker();
            } else if (btn.classList.contains('btn-claim')) {
                // ক্লেইম লজিক (পেজ রিফ্রেশ ছাড়া)
                btn.innerText = "SYNCING...";
                btn.className = "btn-zym btn-active";
                
                try {
                    const newBalance = mainBalance + MINE_LIMIT;
                    await db.collection('users').doc(tgID).update({ 
                        balance: newBalance 
                    });
                    
                    // লোকাল ডাটা আপডেট
                    mainBalance = newBalance;
                    startTime = null;
                    localStorage.removeItem('zym_start_ts');
                    ZYM_STORE.set('bal', mainBalance);
                    
                    // UI আপডেট (রিফ্রেশ ছাড়া)
                    renderApp(); 
                } catch (e) { 
                    alert("Sync Error. Check Connection."); 
                    renderApp();
                }
            }
        });

        tg.expand();
        initApp();
    </script>
</body>
</html>
